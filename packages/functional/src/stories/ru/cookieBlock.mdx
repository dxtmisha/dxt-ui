import {Meta} from '@storybook/addon-docs/blocks'

<Meta title='@dxtmisha/functional/ru/Classes/CookieBlock'/>

# Класс CookieBlock

Статический класс для управления статусом доступа к cookie и соблюдения приватности. Предоставляет простой интерфейс для блокировки или разрешения cookie во всём приложении, интегрируясь с классом Cookie для обеспечения соответствия требованиям приватности как GDPR.

## Основные возможности

- **Глобальный контроль cookie** — централизованный контроль использования cookie во всём приложении
- **Соблюдение приватности** — помогает реализовать GDPR, CCPA и другие регулирования приватности
- **Постоянные настройки** — использует DataStorage для запоминания пользовательских настроек cookie
- **Интеграция с классом Cookie** — класс Cookie автоматически учитывает настройки CookieBlock
- **Простой API** — всего два метода для получения и установки статуса блокировки cookie
- **Совместимость с браузерами** — безопасно работает во всех средах

## Основное использование

### `get`

Получает текущий статус блокировки cookie.

**Возвращает:** `boolean` — true если cookie заблокированы, false если разрешены

```javascript
import { CookieBlock } from '@dxtmisha/functional'

// Проверить, заблокированы ли cookie в данный момент
const isBlocked = CookieBlock.get()
console.log('Cookie заблокированы:', isBlocked) // false по умолчанию

if (isBlocked) {
  console.log('Cookie заблокированы пользовательскими настройками')
} else {
  console.log('Cookie разрешены')
}
```

### `set`

Устанавливает статус блокировки cookie и сохраняет настройку.

**Параметры:**
- `value: boolean` — true для блокировки cookie, false для разрешения

```javascript
// Заблокировать все cookie
CookieBlock.set(true)
console.log('Cookie заблокированы:', CookieBlock.get()) // true

// Разрешить cookie
CookieBlock.set(false)
console.log('Cookie разрешены:', CookieBlock.get()) // false

// Настройка сохраняется между сессиями браузера
// Пользовательские предпочтения сохраняются в localStorage
```

## Интеграция с классом Cookie

Класс CookieBlock автоматически предотвращает операции Cookie когда блокировка включена:

```javascript
import { Cookie, CookieBlock } from '@dxtmisha/functional'

// Создать экземпляр cookie
const userPrefs = new Cookie('user-preferences')

// Изначально cookie разрешены
CookieBlock.set(false)
userPrefs.set({ theme: 'dark', language: 'ru' })
console.log('Сохранённые настройки:', userPrefs.get()) // { theme: 'dark', language: 'ru' }

// Заблокировать cookie
CookieBlock.set(true)

// Операции Cookie теперь предотвращены
userPrefs.set({ theme: 'light', language: 'en' }) // Это фактически не установит cookie
console.log('Настройки после блокировки:', userPrefs.get()) // Всё ещё { theme: 'dark', language: 'ru' }

// Разрешить cookie снова
CookieBlock.set(false)
userPrefs.set({ theme: 'light', language: 'en' }) // Теперь это работает
console.log('Обновлённые настройки:', userPrefs.get()) // { theme: 'light', language: 'en' }
```

## Практические примеры

### Реализация согласия на cookie по GDPR

```javascript
class CookieConsent {
  constructor() {
    this.consentCookie = new Cookie('cookie-consent')
  }

  showConsentBanner() {
    // Проверить, сделал ли пользователь уже выбор
    const consent = this.consentCookie.get()

    if (consent === undefined) {
      // Показать баннер - пользователь ещё не решил
      this.displayBanner()

      // Заблокировать cookie пока пользователь не решит
      CookieBlock.set(true)

      return 'banner-shown'
    } else {
      // Пользователь уже решил
      CookieBlock.set(!consent.accepted)
      return consent.accepted ? 'cookies-allowed' : 'cookies-blocked'
    }
  }

  acceptCookies() {
    // Пользователь принимает cookie
    this.consentCookie.set({
      accepted: true,
      timestamp: Date.now(),
      version: '1.0'
    }, {
      age: 365 * 24 * 60 * 60 // Запомнить на 1 год
    })

    // Разрешить cookie
    CookieBlock.set(false)

    this.hideBanner()

    // Теперь другие cookie могут быть установлены
    this.enableAnalytics()
    this.enableMarketing()
  }

  rejectCookies() {
    // Пользователь отклоняет не-необходимые cookie
    this.consentCookie.set({
      accepted: false,
      timestamp: Date.now(),
      version: '1.0'
    }, {
      age: 365 * 24 * 60 * 60
    })

    // Оставить cookie заблокированными
    CookieBlock.set(true)

    this.hideBanner()

    // Очистить любые существующие не-необходимые cookie
    this.clearNonEssentialCookies()
  }

  enableAnalytics() {
    if (!CookieBlock.get()) {
      const analyticsCookie = new Cookie('analytics')
      analyticsCookie.set({ enabled: true, userId: 'anonymous' })
      console.log('Аналитика включена')
    }
  }

  enableMarketing() {
    if (!CookieBlock.get()) {
      const marketingCookie = new Cookie('marketing')
      marketingCookie.set({ campaigns: [], lastShown: Date.now() })
      console.log('Маркетинговые cookie включены')
    }
  }

  clearNonEssentialCookies() {
    const analytics = new Cookie('analytics')
    const marketing = new Cookie('marketing')

    analytics.remove()
    marketing.remove()

    console.log('Не-необходимые cookie очищены')
  }

  displayBanner() {
    console.log('🍪 Баннер согласия на cookie отображён')
  }

  hideBanner() {
    console.log('Баннер согласия на cookie скрыт')
  }

  getConsentStatus() {
    return this.consentCookie.get()
  }
}

// Использование
const cookieConsent = new CookieConsent()

// Проверить согласие при загрузке страницы
const status = cookieConsent.showConsentBanner()
console.log('Статус согласия:', status)

// Взаимодействия пользователя
if (status === 'banner-shown') {
  // Имитация принятия cookie пользователем
  setTimeout(() => {
    cookieConsent.acceptCookies()
    console.log('Пользователь принял cookie')
  }, 2000)
}

// Проверить финальный статус
setTimeout(() => {
  const finalStatus = cookieConsent.getConsentStatus()
  console.log('Финальное согласие:', finalStatus)
  console.log('Cookie в данный момент заблокированы:', CookieBlock.get())
}, 3000)
```

### Управление настройками приватности

```javascript
class PrivacyManager {
  constructor() {
    this.privacySettings = new Cookie('privacy-settings')
  }

  getPrivacySettings() {
    return this.privacySettings.get({
      essential: true,        // Всегда разрешены
      functional: false,      // Выбор пользователя
      analytics: false,       // Выбор пользователя
      marketing: false        // Выбор пользователя
    })
  }

  updatePrivacySettings(settings) {
    this.privacySettings.set(settings, {
      age: 365 * 24 * 60 * 60 // 1 год
    })

    // Обновить глобальную блокировку cookie на основе настроек
    const shouldBlock = !(settings.functional || settings.analytics || settings.marketing)
    CookieBlock.set(shouldBlock)

    // Применить настройки к отдельным типам cookie
    this.applyCookieSettings(settings)
  }

  applyCookieSettings(settings) {
    if (!settings.analytics) {
      const analyticsCookies = ['_ga', '_gtag', 'analytics-data']
      analyticsCookies.forEach(name => {
        const cookie = new Cookie(name)
        cookie.remove()
      })
    }

    if (!settings.marketing) {
      const marketingCookies = ['marketing-data', 'campaign-tracking', 'ad-preferences']
      marketingCookies.forEach(name => {
        const cookie = new Cookie(name)
        cookie.remove()
      })
    }

    if (!settings.functional) {
      const functionalCookies = ['user-preferences', 'ui-state', 'form-data']
      functionalCookies.forEach(name => {
        const cookie = new Cookie(name)
        cookie.remove()
      })
    }
  }

  hasConsentFor(category) {
    const settings = this.getPrivacySettings()
    return settings[category] || false
  }

  showPrivacyCenter() {
    const current = this.getPrivacySettings()

    console.log('Настройки Центра Приватности:')
    console.log('Необходимые:', current.essential, '(всегда требуются)')
    console.log('Функциональные:', current.functional, '(опциональные)')
    console.log('Аналитика:', current.analytics, '(опциональные)')
    console.log('Маркетинг:', current.marketing, '(опциональные)')

    return current
  }

  acceptAll() {
    this.updatePrivacySettings({
      essential: true,
      functional: true,
      analytics: true,
      marketing: true
    })
    console.log('Все cookie приняты')
  }

  rejectAll() {
    this.updatePrivacySettings({
      essential: true,  // Необходимые cookie нельзя отключить
      functional: false,
      analytics: false,
      marketing: false
    })
    console.log('Не-необходимые cookie отклонены')
  }
}

// Использование
const privacyManager = new PrivacyManager()

// Показать текущие настройки
privacyManager.showPrivacyCenter()

// Проверить конкретное согласие
console.log('Аналитика разрешена:', privacyManager.hasConsentFor('analytics'))
console.log('Маркетинг разрешён:', privacyManager.hasConsentFor('marketing'))

// Обновить настройки
privacyManager.updatePrivacySettings({
  essential: true,
  functional: true,
  analytics: true,
  marketing: false
})

console.log('Обновлённые настройки - Маркетинг отключён')
console.log('Cookie заблокированы глобально:', CookieBlock.get())

// Быстрые действия
// privacyManager.acceptAll()
// privacyManager.rejectAll()
```

### Проверка cookie при запуске приложения

```javascript
class AppInitializer {
  static initializeCookieCompliance() {
    const consent = new Cookie('cookie-consent')
    const consentData = consent.get()

    if (!consentData) {
      // Первый визит - заблокировать cookie пока пользователь не решит
      CookieBlock.set(true)
      console.log('Обнаружен первый визит - cookie заблокированы до получения согласия')
      return 'pending-consent'
    } else {
      // Возвращающийся пользователь - применить их предыдущий выбор
      CookieBlock.set(!consentData.accepted)

      if (consentData.accepted) {
        console.log('Возвращающийся пользователь - cookie разрешены')
        return 'cookies-allowed'
      } else {
        console.log('Возвращающийся пользователь - cookie заблокированы по предпочтениям')
        return 'cookies-blocked'
      }
    }
  }

  static checkCookieStatus() {
    return {
      blocked: CookieBlock.get(),
      hasConsent: new Cookie('cookie-consent').get() !== undefined,
      canSetCookies: !CookieBlock.get()
    }
  }
}

// Запуск приложения
document.addEventListener('DOMContentLoaded', () => {
  const initStatus = AppInitializer.initializeCookieCompliance()
  const cookieStatus = AppInitializer.checkCookieStatus()

  console.log('Статус инициализации приложения:', initStatus)
  console.log('Статус cookie:', cookieStatus)

  // На основе статуса показать соответствующий UI
  if (initStatus === 'pending-consent') {
    showCookieConsentBanner()
  } else if (initStatus === 'cookies-blocked') {
    showPrivacyFriendlyMessage()
  } else {
    enableFullFeatures()
  }
})

function showCookieConsentBanner() {
  console.log('Показ баннера согласия на cookie...')
}

function showPrivacyFriendlyMessage() {
  console.log('Работа в режиме, дружественном к приватности')
}

function enableFullFeatures() {
  console.log('Все функции включены с поддержкой cookie')
}
```

## Интеграция с законами о приватности

CookieBlock помогает обеспечить соответствие с:
- **GDPR** (Общий регламент по защите данных)
- **CCPA** (Закон о конфиденциальности потребителей Калифорнии)
- **ePrivacy Directive** (Директива ЕС о cookie)
- **Другие региональные законы о приватности**

Класс предоставляет основу для реализации управления cookie, соответствующего приватности, которое учитывает пользовательские выборы и регулятивные требования.
