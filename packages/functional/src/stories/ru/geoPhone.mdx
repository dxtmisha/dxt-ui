import {Meta} from '@storybook/addon-docs/blocks'

<Meta title='@dxtmisha/functional/ru/Classes/GeoPhone'/>

# Класс GeoPhone

Статический класс для хранения и обработки масок телефонных номеров. Предоставляет методы для работы с международными телефонными кодами, форматирования номеров по маскам и определения стран по телефонным номерам.

## Основные возможности

- **Международные телефонные коды** — поддержка всех международных кодов стран
- **Маски телефонов** — автоматическое форматирование номеров по национальным стандартам
- **Определение страны по номеру** — идентификация страны на основе телефонного номера
- **Древовидная структура кодов** — эффективный поиск и сопоставление номеров
- **Внутренние коды стран** — поддержка специальных символов для национальных номеров
- **Валидация номеров** — проверка корректности телефонных номеров
- **Статические методы** — все операции доступны без создания экземпляра

## Статические методы

### `get`

Получение объекта с информацией о телефонном коде и стране.

**Параметры:**
- `code: string` — код страны и языка

**Возвращает:** `GeoPhoneValue | undefined` — объект с информацией о телефонном коде или undefined

```javascript
import { GeoPhone } from '@dxtmisha/functional'

// Получение информации о России
const russiaPhone = GeoPhone.get('RU')
console.log(russiaPhone)
// {
//   phone: 7,           // международный код
//   within: 8,          // внутренний код
//   mask: [             // массив масок
//     '+7 *** ***-**-**',
//     '+7 (***) ***-**-**'
//   ],
//   value: 'RU'         // код страны
// }

// Получение информации о США
const usaPhone = GeoPhone.get('US')
console.log(usaPhone)
// {
//   phone: 1,
//   within: 1,
//   mask: ['+1 (***) ***-****'],
//   value: 'US'
// }

// Получение информации о несуществующей стране
const unknown = GeoPhone.get('XX')
console.log(unknown) // undefined
```

### `getByPhone`

Получение информации по телефонному номеру.

**Параметры:**
- `phone: string` — номер телефона

**Возвращает:** `GeoPhoneMapInfo` — объект с информацией о номере

```javascript
// Анализ российского номера
const russianNumber = GeoPhone.getByPhone('+79161234567')
console.log(russianNumber)
// {
//   item: {
//     items: [...],      // массив возможных стран
//     info: {...},       // основная информация
//     value: 'RU',       // код страны
//     mask: [...],       // доступные маски
//     maskFull: [...],   // полные маски
//     next: {...}        // следующие возможные цифры
//   },
//   phone: '9161234567'  // номер без кода страны
// }

// Анализ американского номера
const americanNumber = GeoPhone.getByPhone('+12125551234')
console.log(americanNumber)
// {
//   item: { value: 'US', ... },
//   phone: '2125551234'
// }

// Анализ неполного номера
const partialNumber = GeoPhone.getByPhone('+7916')
console.log(partialNumber)
// {
//   item: { value: 'RU', ... },
//   phone: '916'
// }
```

### `getByCode`

Получение полных данных о маске по коду страны.

**Параметры:**
- `code: string` — код страны и языка

**Возвращает:** `GeoPhoneMap | undefined` — объект с данными о маске или undefined

```javascript
// Получение маски для России
const russiaMask = GeoPhone.getByCode('RU')
console.log(russiaMask)
// {
//   items: [...],        // массив элементов
//   info: {...},         // информация о стране
//   value: 'RU',         // код страны
//   mask: [              // маски с внутренними символами
//     '+7 ~ *** ***-**-**',
//     '+7 (~***) ***-**-**'
//   ],
//   maskFull: [          // полные маски
//     '+7 * *** ***-**-**',
//     '+7 (****) ***-**-**'
//   ],
//   next: {...}          // возможные следующие цифры
// }

// Получение маски для Германии
const germanyMask = GeoPhone.getByCode('DE')
console.log(germanyMask?.mask) // ['+49 *** ******', ...]
```

### `getList`

Получение массива из списка всех телефонных кодов.

**Возвращает:** `GeoPhoneValue[]` — массив всех телефонных кодов

```javascript
// Получение полного списка
const allPhones = GeoPhone.getList()
console.log(allPhones.length) // количество стран с телефонными кодами

// Пример структуры данных
console.log(allPhones[0])
// {
//   phone: 1,             // код страны
//   within: 1,            // внутренний код
//   mask: ['+1 (***) ***-****'],
//   value: 'US'           // код страны
// }

// Поиск стран с кодом +7
const code7Countries = allPhones.filter(item => item.phone === 7)
console.log(code7Countries) // Россия, Казахстан
```

### `getMap`

Получение карты дерева, отсортированной по кодам.

**Возвращает:** `Record<string, GeoPhoneMap>` — карта дерева поиска

```javascript
// Получение полной карты
const phoneMap = GeoPhone.getMap()

// Навигация по дереву для номера +7916...
console.log(phoneMap['7'])        // информация о коде +7
console.log(phoneMap['7'].next)   // возможные следующие цифры
console.log(phoneMap['7'].next['9']) // информация о +79...

// Проверка доступных кодов
const availableCodes = Object.keys(phoneMap)
console.log(availableCodes) // ['1', '7', '33', '49', ...]
```

### `toMask`

Преобразование номера в маску.

**Параметры:**
- `phone: string` — номер телефона
- `masks?: string[]` — массив масок для преобразования

**Возвращает:** `string | undefined` — отформатированный номер или undefined

```javascript
// Форматирование российского номера
const ruMasks = ['+7 (***) ***-**-**', '+7 *** ***-**-**']
const formatted1 = GeoPhone.toMask('9161234567', ruMasks)
console.log(formatted1) // '+7 (916) 123-45-67'

// Форматирование американского номера
const usMasks = ['+1 (***) ***-****']
const formatted2 = GeoPhone.toMask('2125551234', usMasks)
console.log(formatted2) // '+1 (212) 555-1234'

// Форматирование с неподходящей маской
const wrongFormat = GeoPhone.toMask('123', usMasks)
console.log(wrongFormat) // undefined (длина не совпадает)

// Автоматическое определение и форматирование
const phoneInfo = GeoPhone.getByPhone('+79161234567')
if (phoneInfo.item && phoneInfo.phone) {
  const autoFormatted = GeoPhone.toMask(phoneInfo.phone, phoneInfo.item.mask)
  console.log(autoFormatted) // '+7 ~ 916 123-45-67'
}
```

### `removeZero`

Удаление кода страны из входного номера.

**Параметры:**
- `phone: string` — номер телефона

**Возвращает:** `string` — номер без ведущих символов

```javascript
// Удаление ведущего нуля
const withZero = GeoPhone.removeZero('09161234567')
console.log(withZero) // '9161234567'

// Замена 8 на 9 для российских номеров
const withEight = GeoPhone.removeZero('89161234567')
console.log(withEight) // '9161234567'

// Номер без изменений
const normal = GeoPhone.removeZero('9161234567')
console.log(normal) // '9161234567'

// Международный номер без изменений
const international = GeoPhone.removeZero('+79161234567')
console.log(international) // '+79161234567'
```

## Практические примеры

### Компонент ввода телефона

```javascript
class PhoneInput {
  constructor(inputElement, options = {}) {
    this.input = inputElement
    this.countryCode = options.countryCode || 'RU'
    this.autoFormat = options.autoFormat !== false
    this.onCountryChange = options.onCountryChange || (() => {})

    this.init()
  }

  init() {
    this.setupMask()
    this.attachEvents()
    this.createCountrySelector()
  }

  setupMask() {
    const phoneData = GeoPhone.get(this.countryCode)
    if (phoneData && phoneData.mask.length > 0) {
      this.currentMask = phoneData.mask[0]
      this.input.placeholder = this.currentMask
    }
  }

  attachEvents() {
    this.input.addEventListener('input', (e) => {
      if (this.autoFormat) {
        this.formatInput(e)
      }
      this.detectCountry(e.target.value)
    })

    this.input.addEventListener('keydown', (e) => {
      this.handleSpecialKeys(e)
    })

    this.input.addEventListener('paste', (e) => {
      setTimeout(() => this.formatInput(e), 0)
    })
  }

  formatInput(event) {
    const input = event.target
    const value = input.value.replace(/\D/g, '')

    if (value.length === 0) {
      input.value = ''
      return
    }

    const phoneData = GeoPhone.get(this.countryCode)
    if (phoneData && phoneData.mask.length > 0) {
      const formatted = GeoPhone.toMask(value, phoneData.mask)
      if (formatted) {
        const cursorPosition = this.calculateCursorPosition(input.value, formatted, input.selectionStart)
        input.value = formatted
        input.setSelectionRange(cursorPosition, cursorPosition)
      }
    }
  }

  detectCountry(phoneNumber) {
    const phoneInfo = GeoPhone.getByPhone(phoneNumber)

    if (phoneInfo.item && phoneInfo.item.value !== this.countryCode) {
      this.countryCode = phoneInfo.item.value
      this.setupMask()
      this.updateCountrySelector()
      this.onCountryChange(this.countryCode, phoneInfo.item)
    }
  }

  createCountrySelector() {
    const selector = document.createElement('select')
    selector.className = 'country-selector'

    const allCountries = GeoPhone.getList()
    allCountries.forEach(country => {
      const option = document.createElement('option')
      option.value = country.value
      option.textContent = `${country.value} (+${country.phone})`
      if (country.value === this.countryCode) {
        option.selected = true
      }
      selector.appendChild(option)
    })

    selector.addEventListener('change', (e) => {
      this.countryCode = e.target.value
      this.setupMask()
      this.input.value = ''
      this.input.focus()
      this.onCountryChange(this.countryCode)
    })

    this.input.parentNode.insertBefore(selector, this.input)
    this.countrySelector = selector
  }

  updateCountrySelector() {
    if (this.countrySelector) {
      this.countrySelector.value = this.countryCode
    }
  }

  calculateCursorPosition(oldValue, newValue, oldPosition) {
    // Простой алгоритм для сохранения позиции курсора
    let newPosition = oldPosition

    for (let i = 0; i < oldPosition && i < newValue.length; i++) {
      if (oldValue[i] !== newValue[i] && !/\d/.test(newValue[i])) {
        newPosition++
      }
    }

    return Math.min(newPosition, newValue.length)
  }

  handleSpecialKeys(event) {
    // Разрешить backspace, delete, tab, escape, enter
    if ([8, 9, 27, 13, 46].indexOf(event.keyCode) !== -1 ||
        // Разрешить Ctrl+A, Ctrl+C, Ctrl+V, Ctrl+X
        (event.keyCode === 65 && event.ctrlKey) ||
        (event.keyCode === 67 && event.ctrlKey) ||
        (event.keyCode === 86 && event.ctrlKey) ||
        (event.keyCode === 88 && event.ctrlKey)) {
      return
    }

    // Разрешить только цифры
    if ((event.shiftKey || (event.keyCode < 48 || event.keyCode > 57)) &&
        (event.keyCode < 96 || event.keyCode > 105)) {
      event.preventDefault()
    }
  }

  getValue() {
    return this.input.value
  }

  getCleanValue() {
    return this.input.value.replace(/\D/g, '')
  }

  isValid() {
    const phoneData = GeoPhone.get(this.countryCode)
    if (!phoneData) return false

    const cleanValue = this.getCleanValue()
    return phoneData.mask.some(mask => {
      const requiredLength = mask.replace(/[^*]/g, '').length
      return cleanValue.length === requiredLength
    })
  }
}

// Использование
const phoneInput = new PhoneInput(
  document.getElementById('phone-input'),
  {
    countryCode: 'RU',
    autoFormat: true,
    onCountryChange: (countryCode, phoneData) => {
      console.log(`Страна изменена на: ${countryCode}`)
      console.log('Данные:', phoneData)
    }
  }
)
```

### Валидатор телефонных номеров

```javascript
class PhoneValidator {
  constructor() {
    this.phoneList = GeoPhone.getList()
    this.phoneMap = GeoPhone.getMap()
  }

  // Валидация номера
  validate(phoneNumber, countryCode = null) {
    const result = {
      isValid: false,
      country: null,
      formattedNumber: null,
      errors: []
    }

    // Очистка номера
    const cleanNumber = this.cleanPhoneNumber(phoneNumber)

    if (!cleanNumber) {
      result.errors.push('Номер телефона не может быть пустым')
      return result
    }

    // Определение страны
    const phoneInfo = GeoPhone.getByPhone(cleanNumber)

    if (!phoneInfo.item) {
      result.errors.push('Не удалось определить страну по номеру')
      return result
    }

    result.country = phoneInfo.item.value

    // Проверка соответствия указанной стране
    if (countryCode && result.country !== countryCode) {
      result.errors.push(`Номер не соответствует стране ${countryCode}`)
      return result
    }

    // Проверка длины номера
    const isValidLength = phoneInfo.item.mask.some(mask => {
      const requiredLength = mask.replace(/[^*]/g, '').length
      return phoneInfo.phone.length === requiredLength
    })

    if (!isValidLength) {
      result.errors.push('Неверная длина номера')
      return result
    }

    // Форматирование номера
    const formatted = GeoPhone.toMask(phoneInfo.phone, phoneInfo.item.mask)
    if (formatted) {
      result.formattedNumber = formatted
      result.isValid = true
    } else {
      result.errors.push('Не удалось отформатировать номер')
    }

    return result
  }

  // Очистка номера от нечисловых символов
  cleanPhoneNumber(phone) {
    if (typeof phone !== 'string') return ''

    // Удаление всех символов кроме цифр и +
    let cleaned = phone.replace(/[^\d+]/g, '')

    // Если номер начинается с +, оставляем его
    if (cleaned.startsWith('+')) {
      cleaned = '+' + cleaned.slice(1).replace(/[^0-9]/g, '')
    } else {
      cleaned = cleaned.replace(/[^0-9]/g, '')
    }

    return cleaned
  }

  // Получение всех возможных форматов для страны
  getCountryFormats(countryCode) {
    const phoneData = GeoPhone.get(countryCode)
    if (!phoneData) return []

    return phoneData.mask.map(mask => ({
      mask,
      example: this.generateExample(mask),
      description: this.getMaskDescription(mask)
    }))
  }

  // Генерация примера номера по маске
  generateExample(mask) {
    return mask.replace(/\*/g, () => Math.floor(Math.random() * 10))
  }

  // Описание маски
  getMaskDescription(mask) {
    const descriptions = {
      '+7 (***) ***-**-**': 'Российский мобильный номер',
      '+7 *** ***-**-**': 'Российский номер (альтернативный формат)',
      '+1 (***) ***-****': 'Американский номер',
      '+49 *** ******': 'Немецкий номер',
      '+33 * ** ** ** **': 'Французский номер'
    }

    return descriptions[mask] || 'Международный номер'
  }

  // Пакетная валидация
  validateBatch(phoneNumbers, countryCode = null) {
    return phoneNumbers.map(phone => ({
      original: phone,
      validation: this.validate(phone, countryCode)
    }))
  }

  // Статистика валидации
  getValidationStats(results) {
    const total = results.length
    const valid = results.filter(r => r.validation.isValid).length
    const invalid = total - valid

    const countryCounts = {}
    results.forEach(r => {
      if (r.validation.country) {
        countryCounts[r.validation.country] = (countryCounts[r.validation.country] || 0) + 1
      }
    })

    return {
      total,
      valid,
      invalid,
      validPercent: Math.round((valid / total) * 100),
      countryCounts
    }
  }
}

// Использование
const validator = new PhoneValidator()

// Валидация одного номера
const result = validator.validate('+7 (916) 123-45-67')
console.log('Результат валидации:', result)

// Валидация с указанием страны
const resultWithCountry = validator.validate('89161234567', 'RU')
console.log('Валидация для России:', resultWithCountry)

// Получение форматов для страны
const ruFormats = validator.getCountryFormats('RU')
console.log('Форматы для России:', ruFormats)

// Пакетная валидация
const phoneNumbers = [
  '+7 916 123-45-67',
  '8 (916) 123-45-67',
  '+1 (212) 555-1234',
  'invalid phone',
  '+49 30 12345678'
]

const batchResults = validator.validateBatch(phoneNumbers)
console.log('Результаты пакетной валидации:', batchResults)

// Статистика
const stats = validator.getValidationStats(batchResults)
console.log('Статистика:', stats)
```

### Анализатор телефонных номеров

```javascript
class PhoneAnalyzer {
  constructor() {
    this.phoneList = GeoPhone.getList()
    this.phoneMap = GeoPhone.getMap()
  }

  // Подробный анализ номера
  analyzePhone(phoneNumber) {
    const cleanNumber = phoneNumber.replace(/\D/g, '')
    const phoneInfo = GeoPhone.getByPhone(phoneNumber)

    const analysis = {
      original: phoneNumber,
      cleaned: cleanNumber,
      country: null,
      countryCode: null,
      nationalNumber: null,
      possibleFormats: [],
      isValid: false,
      confidence: 0
    }

    if (phoneInfo.item) {
      analysis.country = phoneInfo.item.value
      analysis.countryCode = phoneInfo.item.info?.phone
      analysis.nationalNumber = phoneInfo.phone
      analysis.possibleFormats = phoneInfo.item.mask

      // Проверка валидности
      const validFormat = phoneInfo.item.mask.find(mask => {
        const requiredLength = mask.replace(/[^*]/g, '').length
        return phoneInfo.phone.length === requiredLength
      })

      analysis.isValid = !!validFormat
      analysis.confidence = this.calculateConfidence(phoneInfo, cleanNumber)
    }

    return analysis
  }

  // Расчёт уверенности в определении страны
  calculateConfidence(phoneInfo, cleanNumber) {
    if (!phoneInfo.item) return 0

    let confidence = 50 // базовая уверенность

    // Увеличиваем уверенность если есть точное совпадение длины
    const exactMatch = phoneInfo.item.mask.some(mask => {
      const requiredLength = mask.replace(/[^*]/g, '').length
      return phoneInfo.phone.length === requiredLength
    })

    if (exactMatch) confidence += 30

    // Увеличиваем уверенность если код страны точно определён
    if (phoneInfo.item.info?.phone &&
        cleanNumber.startsWith(phoneInfo.item.info.phone.toString())) {
      confidence += 20
    }

    return Math.min(confidence, 100)
  }

  // Сравнение номеров
  comparePhones(phone1, phone2) {
    const analysis1 = this.analyzePhone(phone1)
    const analysis2 = this.analyzePhone(phone2)

    return {
      areSame: analysis1.cleaned === analysis2.cleaned,
      sameCountry: analysis1.country === analysis2.country,
      phone1: analysis1,
      phone2: analysis2,
      similarity: this.calculateSimilarity(analysis1.cleaned, analysis2.cleaned)
    }
  }

  // Расчёт схожести номеров
  calculateSimilarity(num1, num2) {
    if (num1 === num2) return 100

    const maxLength = Math.max(num1.length, num2.length)
    const minLength = Math.min(num1.length, num2.length)

    let matches = 0
    for (let i = 0; i < minLength; i++) {
      if (num1[i] === num2[i]) matches++
    }

    return Math.round((matches / maxLength) * 100)
  }

  // Поиск похожих номеров
  findSimilarFormats(phoneNumber) {
    const analysis = this.analyzePhone(phoneNumber)
    if (!analysis.country) return []

    const countryData = GeoPhone.get(analysis.country)
    if (!countryData) return []

    return countryData.mask.map(mask => {
      const formatted = GeoPhone.toMask(analysis.nationalNumber, [mask])
      return {
        mask,
        formatted,
        description: this.getMaskDescription(mask)
      }
    }).filter(item => item.formatted)
  }

  getMaskDescription(mask) {
    // Анализ маски для создания описания
    const digitCount = (mask.match(/\*/g) || []).length
    const hasParentheses = mask.includes('(') && mask.includes(')')
    const hasDashes = mask.includes('-')
    const hasSpaces = mask.includes(' ')

    let description = `${digitCount} цифр`

    if (hasParentheses) description += ', с скобками'
    if (hasDashes) description += ', с дефисами'
    if (hasSpaces) description += ', с пробелами'

    return description
  }

  // Извлечение номеров из текста
  extractPhonesFromText(text) {
    // Регулярные выражения для поиска номеров
    const patterns = [
      /\+\d{1,3}\s*\(?\d{1,4}\)?\s*[\d\s\-\(\)]{6,}/g,  // международные номера
      /\b\d{3}[\s\-]?\d{3}[\s\-]?\d{4}\b/g,              // американские номера
      /\b[78]\d{10}\b/g,                                  // российские номера
      /\b\d{1,4}[\s\-]\d{3,4}[\s\-]\d{3,4}[\s\-]?\d{0,4}\b/g // общие паттерны
    ]

    const foundNumbers = new Set()

    patterns.forEach(pattern => {
      const matches = text.match(pattern) || []
      matches.forEach(match => foundNumbers.add(match.trim()))
    })

    return Array.from(foundNumbers).map(phone => this.analyzePhone(phone))
  }

  // Статистика по всем доступным странам
  getGlobalPhoneStatistics() {
    const stats = {
      totalCountries: this.phoneList.length,
      codeDistribution: {},
      maskComplexity: {},
      averageMasks: 0
    }

    this.phoneList.forEach(country => {
      // Распределение по кодам
      const code = country.phone
      stats.codeDistribution[code] = (stats.codeDistribution[code] || 0) + 1

      // Сложность масок
      const complexity = country.mask.reduce((acc, mask) => {
        return acc + (mask.match(/\*/g) || []).length
      }, 0) / country.mask.length

      stats.maskComplexity[country.value] = Math.round(complexity)
    })

    // Среднее количество масок на страну
    const totalMasks = this.phoneList.reduce((acc, country) => acc + country.mask.length, 0)
    stats.averageMasks = Math.round(totalMasks / this.phoneList.length * 100) / 100

    return stats
  }
}

// Использование
const analyzer = new PhoneAnalyzer()

// Анализ номера
const analysis = analyzer.analyzePhone('+7 (916) 123-45-67')
console.log('Анализ номера:', analysis)

// Сравнение номеров
const comparison = analyzer.comparePhones('+7 916 123-45-67', '8 (916) 123-45-67')
console.log('Сравнение:', comparison)

// Поиск похожих форматов
const similarFormats = analyzer.findSimilarFormats('+79161234567')
console.log('Похожие форматы:', similarFormats)

// Извлечение номеров из текста
const text = 'Позвоните мне: +7 916 123-45-67 или 8 (495) 123-45-67. Американский номер: +1 (212) 555-1234'
const extractedPhones = analyzer.extractPhonesFromText(text)
console.log('Найденные номера:', extractedPhones)

// Глобальная статистика
const globalStats = analyzer.getGlobalPhoneStatistics()
console.log('Глобальная статистика:', globalStats)
```

Класс GeoPhone предоставляет мощный инструментарий для работы с телефонными номерами, включая валидацию, форматирование, определение стран и анализ номеров с поддержкой международных стандартов.
