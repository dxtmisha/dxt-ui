import {Meta} from '@storybook/addon-docs/blocks'

<Meta title='[title]'/>

# Class TaskManager

An advanced manager for handling asynchronous tasks with support for priorities, dependencies, and execution queues. Allows organizing complex workflows with state control and error handling.

## Key Features

- **Execution Queues** — management of sequential and parallel execution
- **Prioritization** — weight system for determining task launch order
- **Dependencies** — ability to specify tasks that must be completed before the current one
- **Retries** — automatic task restart on failures
- **Event Model** — subscription to status changes and execution progress

## Data Types

### Task Configuration (TaskConfig)

Configuration object defining parameters for the created task.

**TaskConfig Properties:**
- `id?: string` — unique identifier (auto-generated if not specified)
- `handler: (ctx: TaskContext) => Promise<any>` — task execution function
- `priority?: number` — execution priority (default: `10`)
- `dependencies?: string[]` — array of task IDs that this task depends on
- `retry?: RetryOptions` — settings for retry attempts on error
- `timeout?: number` — maximum execution time in ms

```javascript
const config = {
  priority: 100,
  dependencies: ['auth-task'],
  timeout: 5000,
  handler: async (ctx) => {
    return await api.fetchData()
  }
}
```

### Execution Result (TaskResult<T>)

Object returned after task completion.

**TaskResult Properties:**
- `taskId: string` — identifier of the completed task
- `status: 'success' | 'error' | 'timeout'` — final status
- `data?: T` — data returned by the handler (on success)
- `error?: Error` — error object (on failure)
- `executionTime: number` — execution time in milliseconds

## Class Methods

### `registerTask`

Registers a new task in the scheduler system.

**Parameters:**
- `config: TaskConfig` — task configuration

**Returns:** `string` — identifier of the registered task

```javascript
import { TaskManager } from '@dxtmisha/functional'

const taskId = TaskManager.registerTask({
  priority: 50,
  handler: async () => {
    console.log('Executing critical task')
    return 'done'
  }
})
```

### `executeAll`

Starts execution of all registered tasks considering their dependencies and priorities.

**Parameters:**
- `concurrency: number` — maximum number of parallel tasks (default: `5`)

**Returns:** `Promise<Map<string, TaskResult<any>>>` — map of execution results

```javascript
// Run with a limit of 3 parallel threads
const results = await TaskManager.executeAll(3)

if (results.get(taskId).status === 'success') {
  console.log('Task completed successfully')
}
```

### `onProgress`

Subscribes to progress updates of a task group execution.

**Parameters:**
- `callback: (progress: number, active: number) => void` — callback function

**Returns:** `() => void` — unsubscribe function

```javascript
const unsubscribe = TaskManager.onProgress((percent, activeCount) => {
  console.log(`Progress: ${percent}%, Active tasks: ${activeCount}`)
})

// Unsubscribe later
unsubscribe()
```

