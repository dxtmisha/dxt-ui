import {Meta} from '@storybook/addon-docs/blocks'

<Meta title='[title]'/>

# Класс TaskManager

Продвинутый менеджер для управления асинхронными задачами с поддержкой приоритетов, зависимостей и очередей выполнения. Позволяет организовывать сложные рабочие процессы с контролем состояния и обработкой ошибок.

## Основные возможности

- **Очереди выполнения** — управление последовательным и параллельным выполнением
- **Приоритезация** — система весов для определения порядка запуска задач
- **Зависимости** — возможность указать задачи, которые должны быть выполнены перед текущей
- **Повторные попытки** — автоматический перезапуск задач при сбоях
- **Событийная модель** — подписка на изменение статуса и прогресса выполнения

## Типы данных

### Конфигурация задачи (TaskConfig)

Объект конфигурации, определяющий параметры создаваемой задачи.

**Свойства TaskConfig:**
- `id?: string` — уникальный идентификатор (генерируется автоматически, если не указан)
- `handler: (ctx: TaskContext) => Promise<any>` — функция выполнения задачи
- `priority?: number` — приоритет выполнения (по умолчанию: `10`)
- `dependencies?: string[]` — массив ID задач, от которых зависит данная задача
- `retry?: RetryOptions` — настройки повторных попыток при ошибке
- `timeout?: number` — максимальное время выполнения в мс

```javascript
const config = {
  priority: 100,
  dependencies: ['auth-task'],
  timeout: 5000,
  handler: async (ctx) => {
    return await api.fetchData()
  }
}
```

### Результат выполнения (TaskResult<T>)

Объект, возвращаемый после завершения задачи.

**Свойства TaskResult:**
- `taskId: string` — идентификатор выполненной задачи
- `status: 'success' | 'error' | 'timeout'` — итоговый статус
- `data?: T` — данные, возвращенные обработчиком (при успехе)
- `error?: Error` — объект ошибки (при сбое)
- `executionTime: number` — время выполнения в миллисекундах

## Методы класса

### `registerTask`

Регистрирует новую задачу в системе планировщика.

**Параметры:**
- `config: TaskConfig` — конфигурация задачи

**Возвращает:** `string` — идентификатор зарегистрированной задачи

```javascript
import { TaskManager } from '@dxtmisha/functional'

const taskId = TaskManager.registerTask({
  priority: 50,
  handler: async () => {
    console.log('Выполнение важной задачи')
    return 'done'
  }
})
```

### `executeAll`

Запускает выполнение всех зарегистрированных задач с учетом их зависимостей и приоритетов.

**Параметры:**
- `concurrency: number` — максимальное количество параллельных задач (по умолчанию: `5`)

**Возвращает:** `Promise<Map<string, TaskResult<any>>>` — карта результатов выполнения

```javascript
// Запуск с ограничением в 3 параллельных потока
const results = await TaskManager.executeAll(3)

if (results.get(taskId).status === 'success') {
  console.log('Задача выполнена успешно')
}
```

### `onProgress`

Подписывается на обновления прогресса выполнения группы задач.

**Параметры:**
- `callback: (progress: number, active: number) => void` — функция обратного вызова

**Возвращает:** `() => void` — функция отписки

```javascript
const unsubscribe = TaskManager.onProgress((percent, activeCount) => {
  console.log(`Прогресс: ${percent}%, Активных задач: ${activeCount}`)
})

// Позже отписаться
unsubscribe()
```

