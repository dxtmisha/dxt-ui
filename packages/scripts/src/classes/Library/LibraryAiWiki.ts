import { PropertiesFile } from '../Properties/PropertiesFile'
import { LibraryItems } from './LibraryItems'
import { LibraryAiWikiItem } from './LibraryAiWikiItem'

import { UI_DIRS_COMPONENTS } from '../../config'

/**
 * Class for creating a list of components for AI Wiki.
 *
 * Класс для создания списка компонентов для AI Wiki.
 */
export class LibraryAiWiki {
  /**
   * Constructor
   * @param items object for working with the list of components / объект для работы со списком компонентов
   */
  constructor(
    protected readonly items: LibraryItems
  ) {
  }

  /**
   * Creates files for AI Wiki.
   *
   * Создает файлы для AI Wiki.
   */
  make(): void {
    this.makeList()
    this.makeComponent()
  }

  /**
   * Returns the file name for the list.
   *
   * Возвращает имя файла для списка.
   */
  protected getFileList(): string {
    return 'ai-list'
  }

  /**
   * Returns a list of components for AI Wiki.
   *
   * Возвращает список компонентов для AI Wiki.
   */
  protected getList(): LibraryAiWikiItem[] {
    const data: LibraryAiWikiItem[] = []

    this.items.getComponentList()
      .forEach((component) => {
        const aiWiki = new LibraryAiWikiItem(component)

        if (aiWiki.isAiWiki()) {
          data.push(aiWiki)
        }
      })

    return data
  }

  /**
   * Creates a file with a list of components.
   *
   * Создает файл со списком компонентов.
   */
  protected makeList(): void {
    const data = this.getList()
    const imports: string[] = []
    const list: string[] = []

    console.log('Ai wiki:', data.length, 'components')

    data.forEach((item) => {
      imports.push(item.getImport())
      list.push(`  ${item.getCode()}`)
    })

    this.items.write(
      this.getFileList(),
      [
        ...imports,
        '',
        'export const aiList: any[] = [',
        list.join(',\r\n'),
        ']'
      ],
      'wiki.ts'
    )
  }

  /**
   * Creates a component for displaying the list.
   *
   * Создает компонент для отображения списка.
   */
  protected makeComponent() {
    PropertiesFile.writeByPath(
      [...UI_DIRS_COMPONENTS, 'AiWiki.vue'],
      `<script setup lang="ts">
// This file is generated by a script, do not edit.

import { DxtTestPage, DxtTestWikiAnchor } from '@dxtmisha/test'
import { aiList } from '../library/${this.getFileList()}.wiki'

defineOptions({
  name: 'AiWiki'
})
</script>

<template>
  <DxtTestPage
    title="List of available UI components"
    description="Below is a list of Vue 3 components available in the UI. These components are available immediately and do not need to be imported."
  >
    <DxtTestWikiAnchor :list="aiList"/>
    <component
      v-for="(item, key) in aiList"
      :key="key"
      :is="item"
    />
  </DxtTestPage>
</template>
`
    )
  }
}
